{% extends "base/base.html" %}
{% block stylesheet %}
<link rel="stylesheet" href="/static/css/index.css">
{% endblock stylesheet %}

{% block content %}
<div class="content">
  <div class="header">
    <h1>🚆 Line Status - <span id="current-tab">🌍 Public</span></h1>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const currentTabElement = document.getElementById('current-tab');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
        currentTabElement.textContent = button.textContent.trim();
        });
      });
      });
    </script>
  </div>
  <div class="tabs" style="display: flex; gap: 10px;">
    <button class="tab-btn active" data-tab="public"><b>🌍 Public</b></button>
    <button class="tab-btn" data-tab="private"><b>🔒 Private</b></button>
    <button class="tab-btn" data-tab="metro"><b>🚇 Metro</b></button>
    <button class="tab-btn" data-tab="tram"><b>🚋 Tram</b></button>
    <button class="tab-btn" data-tab="bus"><b>🚌 Bus</b></button>
  </div>
  {% if maintenance_mode %}
  <div class="line-status maintenance-mode" style="background-color: rgb(255, 115, 0);">
    <h3 id="maintenance-toggle" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
      🚧 Maintenance <span id="maintenance-arrow" style="transition: transform 0.3s; display: inline-block;">▼</span>
    </h3>
    <div id="maintenance-message-static"></div>
    <div id="maintenance-message-collapsible" style="max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(.4,0,.2,1), opacity 0.4s; opacity: 0;"></div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const rawHtml = `{{ maintenance_message | safe }}`;
        let staticPart = '';
        let collapsiblePart = rawHtml;
        const h1Match = rawHtml.match(/<h1[^>]*>.*?<\/h1>/i);

        if (h1Match) {
          staticPart = h1Match[0];
          collapsiblePart = rawHtml.replace(h1Match[0], '');
        }

        document.getElementById('maintenance-message-static').innerHTML = staticPart;
        document.getElementById('maintenance-message-collapsible').innerHTML = collapsiblePart;

        const toggle = document.getElementById('maintenance-toggle');
        const collapsible = document.getElementById('maintenance-message-collapsible');
        const arrow = document.getElementById('maintenance-arrow');
        let expanded = false;
        
        toggle.addEventListener('click', function() {
          expanded = !expanded;
          if (expanded) {
            collapsible.style.maxHeight = collapsible.scrollHeight + 'px';
            collapsible.style.opacity = '1';
            arrow.style.transform = 'rotate(180deg)';
          } else {
            collapsible.style.maxHeight = '0';
            collapsible.style.opacity = '0';
            arrow.style.transform = 'rotate(0deg)';
          }
        });
      });
    </script>
  </div>
  {% endif %}

  {% for type, status in line_types.items() %}
  <div class="tab-content {% if type == 'public' %}active{% endif %}" id="{{ type }}">
    {% if status.suspended or status.partially_suspended %}
    <div class="possible-delays-no-scheduled-service-container">
      {% if status.suspended %}
      <div id="suspended" class="line-status" style="flex: 1;">
        <div class="line-status--header">
          <h1>🚫 Suspended</h1>
          <p>Service is currently suspended</p>
        </div>

        <div class="lines">
          {% for line in status.suspended %}
          <div class="line-item line" data-line="{{ line.name }}" id="line-{{ line.name }}">
            {{ line.name }}
          </div>
          <script>
              setContrastColor('line-{{ line.name }}', '{{ line.color }}');
          </script>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if status.partially_suspended %}
      <div id="partially-suspended" class="line-status" style="flex: 1;">
        <div class="line-status--header">
          <h1>〽️ Partially Suspended</h1>
          <p>Service may be affected (e.g. unserviced stations)</p>
        </div>
        
        <div class="lines">
          {% for line in status.partially_suspended %}
          <div class="line-item line" data-line="{{ line.name }}" id="line-{{ line.name }}">
            {{ line.name }}
          </div>
          <script>
              setContrastColor('line-{{ line.name }}', '{{ line.color }}');
          </script>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}
    
    {% if status.possible_delays or status.no_scheduled %}
    <div class="possible-delays-no-scheduled-service-container">
      {% if status.possible_delays %}
      <div id="possibledelays" class="line-status" style="flex: 1;">
        <div class="line-status--header">
          <h1>⚠️ Possible delays</h1>
          <p>Services may be delayed</p>
        </div>

        <div class="lines">
          {% for line in status.possible_delays %}
          <div class="line-item line" data-line="{{ line.name }}" id="line-{{ line.name }}">
            {{ line.name }}
          </div>
          <script>
              setContrastColor('line-{{ line.name }}', '{{ line.color }}');
          </script>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if status.no_scheduled %}
      <div id="noscheduledservice" class="line-status" style="flex: 1;">
        <div class="line-status--header">
          <h1>🌙 No scheduled service</h1>
          <p>Lines with no scheduled service</p>
        </div>

        <div class="lines">
          {% for line in status.no_scheduled %}
          <div class="line-item line" data-line="{{ line.name }}" id="line-{{ line.name }}">
            {{ line.name }}
          </div>
          <script>
              setContrastColor('line-{{ line.name }}', '{{ line.color }}');
          </script>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <div id="running" class="line-status">
      <div class="line-status--header">
        <h1>{% if status.running %}🚄 Running service{% else %}❌ No active service{% endif %}</h1>
        <p>{% if status.running %}Lines with active service{% else %}No service is currently running{% endif %}</p>
      </div>
      
      <div class="lines">
        {% if not status.running %}
        <p>No active service available</p>
        {% endif %}
        {% for line in status.running %}
        <div class="line-item line" data-line="{{ line.name }}" id="line-{{ line.name }}">
            {{ line.name }}
        </div>
        <script>
            setContrastColor('line-{{ line.name }}', '{{ line.color }}');
        </script>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}

  <div id="modal" class="modal">
    <div class="modal-content" style="margin-top: 40px">
      <span id="close">&times;</span>
      <div id="modal-inner"></div>
    </div>
  </div>
</div>

<script src="/static/js/lines.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    fetchLines();
  });
</script>
{% endblock content %}