{% extends "base/base.html" %}
{% block stylesheet %}
<link rel="stylesheet" href="/static/css/index.css">
<link rel="stylesheet" href="/static/css/admin.css">
{% endblock stylesheet %}

{% block content %}
<div class="log-content">
    <div class="container">
        <div class="logs-header">
            <div class="logs-title">
                <h1><span class="material-symbols-outlined">description</span>System Logs</h1>
                <p>Monitor and analyze system activities in real-time</p>
            </div>
            <div class="logs-stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalLogs">{{ logs|length }}</span>
                    <span class="stat-label">Total Logs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number error-count" id="errorCount">0</span>
                    <span class="stat-label">Errors</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number warning-count" id="warningCount">0</span>
                    <span class="stat-label">Warnings</span>
                </div>
            </div>
        </div>



        <div class="log-container">
            <div class="log-header-row">
                <span class="col-time">Timestamp</span>
                <span class="col-level">Level</span>
                <span class="col-message">Message</span>
            </div>
            <div class="log-entries" id="logEntries">
                {% for log in logs|reverse %}
                <div class="log-entry"
                    data-level="{{ log[1].split('[')[1].split(']')[0] if '[' in log[1] else 'INFO' }}">
                    <div class="log-level-indicator"></div>
                    <span class="log-timestamp">{{ log[0] }}</span>
                    <span class="log-level-badge">{{ log[1].split('[')[1].split(']')[0] if '[' in log[1] else 'INFO'
                        }}</span>
                    <span class="log-message">{{ log[1] }}</span>
                </div>
                {% endfor %}
            </div>
            <div class="log-footer">
                <div class="log-status">
                    <span id="filteredCount">{{ logs|length }}</span> entries shown
                </div>
                <div class="auto-refresh">
                    <label class="switch">
                        <input type="checkbox" id="autoRefresh">
                        <span class="slider"></span>
                    </label>
                    <span>Auto-refresh</span>
                </div>
            </div>
        </div>

        <div class="log-controls">
            <div class="search-container">
                <span class="material-symbols-outlined search-icon">search</span>
                <input type="text" id="logSearch" placeholder="Search through logs..." class="search-input">
            </div>
            <div class="filter-container">
                <span class="material-symbols-outlined filter-icon">filter_list</span>
                <select id="logLevel" class="level-select">
                    <option value="all">All Levels</option>
                    <option value="INFO">üìò Info</option>
                    <option value="WARNING">‚ö†Ô∏è Warning</option>
                    <option value="ERROR">üö® Error</option>
                    <option value="ADMIN">üë®‚Äçüíº Admin</option>
                </select>
            </div>
            <div class="action-buttons">
                <button onclick="updateLogs()" class="action-btn refresh-btn" title="Refresh logs">
                    <span class="material-symbols-outlined">refresh</span>
                    <span>Refresh</span>
                </button>
                <button onclick="clearLogs()" class="action-btn clear-btn" title="Clear all logs">
                    <span class="material-symbols-outlined">delete</span>
                    <span>Clear</span>
                </button>
            </div>
        </div>

    </div>
</div>

<script>
    document.getElementById('logSearch').addEventListener('input', filterLogs);
    document.getElementById('logLevel').addEventListener('change', filterLogs);

    let autoRefreshInterval;
    document.getElementById('autoRefresh').addEventListener('change', function () {
        if (this.checked) {
            autoRefreshInterval = setInterval(updateLogs, 5000);
        } else {
            clearInterval(autoRefreshInterval);
        }
    });

    function updateStats() {
        const entries = document.querySelectorAll('.log-entry');
        let errorCount = 0;
        let warningCount = 0;

        entries.forEach(entry => {
            const level = entry.dataset.level;
            if (level === 'ERROR') errorCount++;
            if (level === 'WARNING') warningCount++;
        });

        document.getElementById('errorCount').textContent = errorCount;
        document.getElementById('warningCount').textContent = warningCount;
        document.getElementById('totalLogs').textContent = entries.length;
    }

    function filterLogs() {
        const searchText = document.getElementById('logSearch').value.toLowerCase();
        const selectedLevel = document.getElementById('logLevel').value;
        let visibleCount = 0;

        document.querySelectorAll('.log-entry').forEach(entry => {
            const text = entry.textContent.toLowerCase();
            const level = entry.dataset.level;
            const matchesSearch = text.includes(searchText);
            const matchesLevel = selectedLevel === 'all' || level === selectedLevel;

            if (matchesSearch && matchesLevel) {
                entry.style.display = 'flex';
                visibleCount++;
            } else {
                entry.style.display = 'none';
            }
        });

        document.getElementById('filteredCount').textContent = visibleCount;
    }

    function clearLogs() {
        if (confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
            fetch('/api/admin/logs/clear', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('logEntries').innerHTML = '<div class="no-logs">No logs available</div>';
                        updateStats();
                        showNotification('Logs cleared successfully', 'success');
                    }
                })
                .catch(err => {
                    showNotification('Failed to clear logs', 'error');
                });
        }
    }

    function updateLogs() {
        const refreshBtn = document.querySelector('.refresh-btn');
        refreshBtn.classList.add('loading');

        fetch('/api/admin/logs')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const logContainer = document.getElementById('logEntries');
                    logContainer.innerHTML = '';

                    if (data.logs.length === 0) {
                        logContainer.innerHTML = '<div class="no-logs">No logs available</div>';
                    } else {
                        data.logs.reverse().forEach(log => {
                            const logEntry = document.createElement('div');
                            logEntry.className = 'log-entry';
                            const level = log[1].includes('[') ? log[1].split('[')[1].split(']')[0] : 'INFO';
                            logEntry.setAttribute('data-level', level);

                            const timestamp = escapeHtml(log[0]);
                            const message = escapeHtml(log[1]);

                            logEntry.innerHTML = `
                            <div class="log-level-indicator"></div>
                            <span class="log-timestamp">${timestamp}</span>
                            <span class="log-level-badge">${level}</span>
                            <span class="log-message">${message}</span>
                        `;
                            logContainer.appendChild(logEntry);
                        });
                    }
                    updateStats();
                    filterLogs();
                    showNotification('Logs updated successfully', 'success');
                }
            })
            .catch(err => {
                showNotification('Failed to update logs', 'error');
            })
            .finally(() => {
                refreshBtn.classList.remove('loading');
            });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Initialize stats on page load
    document.addEventListener('DOMContentLoaded', function () {
        updateStats();
    });
</script>
{% endblock content %}