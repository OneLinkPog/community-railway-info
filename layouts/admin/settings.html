{% extends "base/base.html" %}
{% block stylesheet %}
<link rel="stylesheet" href="/static/css/index.css">
<link rel="stylesheet" href="/static/css/admin.css">
{% endblock stylesheet %}

{% block content %}
<div class="content">
    <form id="settingsForm" onsubmit="handleSettingsSubmit(event)">
        <h1>⚙️ Settings</h1>

        <div class="form-group">
            <label for="port">Port</label>
            <input type="number" id="port" name="port" value="{{ config.webserver.port }}" class="monospace">
        </div>
        <div class="form-group">
            <label for="debug">Debug Mode</label>
            <div class="smd-component_toggle{% if config.webserver.debug %} smd-component_toggle--active{% endif %}" onclick="toggleSwitch(this)" id="debug"></div>
        </div>
        <div class="form-group">
            <label for="readonly">Readonly Mode</label>
            <div class="smd-component_toggle{% if config.administration.readonly %} smd-component_toggle--active{% endif %}" onclick="toggleSwitch(this)" id="readonly"></div>
        </div>
        <div class="form-group">
            <label for="web_admins">Administrators</label>
            <input type="text" id="web_admins" name="web_admins" value="{{ config.administration.web_admins|join(',') }}" class="monospace">
        </div>
        <div class="form-group">
            <label for="maintenance_mode">Maintenance Mode</label>
            <div class="smd-component_toggle{% if config.administration.maintenance_mode %} smd-component_toggle--active{% endif %}" onclick="toggleSwitch(this)" id="maintenance_mode"></div>
        </div>
        <div class="form-group">
            <label for="maintenance_message">Maintenance Message</label>
            <textarea id="maintenance_message" name="maintenance_message" class="monospace">{{ config.administration.maintenance_message }}</textarea>
        </div>
        <button type="submit" class="smd-component_button-medium smd-component_button-flex">
            <div class="smd-component_button-inner">
                <span class="material-symbols-outlined">save</span>
                Save
            </div>
        </button>
    </form>
</div>

<script>
function toggleSwitch(element) {
    element.classList.toggle('smd-component_toggle--active');
}

async function handleSettingsSubmit(event) {
    event.preventDefault();
    
    const formData = {
        port: parseInt(document.getElementById('port').value),
        debug: document.getElementById('debug').classList.contains('smd-component_toggle--active'),
        readonly: document.getElementById('readonly').classList.contains('smd-component_toggle--active'),
        web_admins: document.getElementById('web_admins').value.split(',').map(id => id.trim()),
        maintenance_mode: document.getElementById('maintenance_mode').classList.contains('smd-component_toggle--active'),
        maintenance_message: document.getElementById('maintenance_message').value
    };

    try {
        const response = await fetch('/api/admin/settings/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();
        
        if (response.ok) {
            alert('Settings saved successfully!');
            window.location.reload();
        } else {
            alert('Error saving settings: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving settings: ' + error.message);
    }
}
</script>
{% endblock content %}